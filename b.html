<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QR Generator + Scanner</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa6b2;--accent:#60a5fa}
    *{box-sizing:border-box}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:0;background:linear-gradient(180deg,#071029 0%, #0b1530 100%);color:#e6eef6;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .wrap{width:1000px;max-width:100%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    h1{margin:0 0 6px;font-size:20px}
    p.lead{margin:0 0 18px;color:var(--muted)}
    .tabs{display:flex;gap:10px;margin-bottom:20px}
    .tabs button{flex:1;padding:10px;border:none;border-radius:8px;cursor:pointer;font-weight:600}
    .tabs button.active{background:var(--accent);color:#042029}
    .tabs button:not(.active){background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .section{display:none}
    .section.active{display:block}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:18px}
    .card{background:rgba(255,255,255,0.02);padding:14px;border-radius:10px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type=text],textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    textarea{min-height:88px;resize:vertical}
    .row{display:flex;gap:8px;margin-top:10px}
    button.action{background:var(--accent);border:none;color:#042029;padding:10px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .preview{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px}
    #qrcode{background:white;padding:12px;border-radius:8px}
    .meta{font-size:13px;color:var(--muted);word-break:break-all;text-align:center}
    .history{margin-top:12px;max-height:240px;overflow:auto}
    .history-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:8px}
    .history-item img{width:56px;height:56px;background:#fff;border-radius:6px}
    .history-item .info{flex:1}
    .small{font-size:12px;color:var(--muted)}
    video{width:100%;border-radius:10px;margin-top:10px}
    footer{margin-top:12px;font-size:12px;color:var(--muted);text-align:right}
    @media (max-width:880px){.grid{grid-template-columns:1fr;}.preview{padding-top:8px}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>QR Generator + Scanner</h1>
    <p class="lead">Generate new QR codes with names or scan existing ones using your device camera.</p>

    <div class="tabs">
      <button id="tabGen" class="active">Generator</button>
      <button id="tabScan">Scanner</button>
    </div>

    <!-- Generator Section -->
    <div id="sectionGen" class="section active">
      <div class="grid">
        <div class="card">
          <label for="name">Name</label>
          <input id="name" type="text" placeholder="e.g. Ritish Verma">
          <label for="content" style="margin-top:12px">Content</label>
          <textarea id="content" placeholder="https://example.com/attendance">https://example.com/attendance</textarea>
          <label for="format" style="margin-top:12px">QR Format</label>
          <select id="format">
            <option value="auto">Auto (append name if URL)</option>
            <option value="embed">Embed JSON</option>
            <option value="raw">Raw content</option>
          </select>
          <div class="row" style="margin-top:14px">
            <button id="generate" class="action">Generate QR</button>
            <button id="download" class="ghost" disabled>Download PNG</button>
            <button id="copylink" class="ghost" disabled>Copy final</button>
          </div>
          <div class="history card" id="history"></div>
        </div>
        <div class="card preview">
          <div id="qrcode"></div>
          <div class="meta">
            <div id="finalText">No QR yet</div>
            <div class="small" id="filename"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scanner Section -->
    <div id="sectionScan" class="section">
      <div class="card">
        <button id="startScan" class="action">Start Camera</button>
        <button id="stopScan" class="ghost" disabled>Stop</button>
        <video id="video" autoplay playsinline></video>
        <div class="card" style="margin-top:10px">
          <strong>Scanned Result:</strong>
          <div id="scanResult" class="small">No result yet</div>
        </div>
      </div>
    </div>

    <footer>Everything works locally — no server needed.</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <script>
    // Tab switching
    const tabGen=document.getElementById('tabGen');
    const tabScan=document.getElementById('tabScan');
    const sectionGen=document.getElementById('sectionGen');
    const sectionScan=document.getElementById('sectionScan');
    tabGen.onclick=()=>{tabGen.classList.add('active');tabScan.classList.remove('active');sectionGen.classList.add('active');sectionScan.classList.remove('active');}
    tabScan.onclick=()=>{tabScan.classList.add('active');tabGen.classList.remove('active');sectionScan.classList.add('active');sectionGen.classList.remove('active');}

    // Generator logic
    const nameInput=document.getElementById('name');
    const contentInput=document.getElementById('content');
    const generateBtn=document.getElementById('generate');
    const downloadBtn=document.getElementById('download');
    const copyBtn=document.getElementById('copylink');
    const qrcodeEl=document.getElementById('qrcode');
    const finalTextEl=document.getElementById('finalText');
    const filenameEl=document.getElementById('filename');
    const historyEl=document.getElementById('history');
    const history=[];

    function looksLikeUrl(str){try{new URL(str);return true}catch(e){return false}}
    function attachNameToUrl(urlStr,name){try{const u=new URL(urlStr);u.searchParams.set('name',name);return u.toString()}catch(e){return urlStr+(urlStr.includes('?')?'&':'?')+'name='+encodeURIComponent(name)}}
    function makeFilename(name){const safe=(name||'qr').replace(/[^a-zA-Z0-9-_]/g,'_')||'qr';return `${safe}_qr.png`;}

    async function generate(){
      const name=nameInput.value.trim();
      const content=contentInput.value.trim();
      const mode=document.getElementById('format').value;
      if(!content){alert('Enter content');return;}
      let final=content;
      if(mode==='auto'&&looksLikeUrl(content)&&name){final=attachNameToUrl(content,name)}
      else if(mode==='embed'){final=JSON.stringify({name,content})}
      else if(mode==='auto'&&!looksLikeUrl(content)&&name){final=`${name} — ${content}`}

      qrcodeEl.innerHTML='';
      const canvas=document.createElement('canvas');
      qrcodeEl.appendChild(canvas);
      await QRCode.toCanvas(canvas,final,{errorCorrectionLevel:'H',margin:2,width:280});
      finalTextEl.textContent=final;
      const filename=makeFilename(name);
      filenameEl.textContent=filename;
      const dataUrl=canvas.toDataURL('image/png');
      downloadBtn.disabled=false;copyBtn.disabled=false;
      downloadBtn.onclick=()=>downloadDataUrl(dataUrl,filename);
      copyBtn.onclick=async()=>{await navigator.clipboard.writeText(final);copyBtn.textContent='Copied!';setTimeout(()=>copyBtn.textContent='Copy final',1000)};
    }

    function downloadDataUrl(dataUrl,filename){const a=document.createElement('a');a.href=dataUrl;a.download=filename;a.click();}
    generateBtn.onclick=generate;

    // Scanner logic
    const video=document.getElementById('video');
    const startBtn=document.getElementById('startScan');
    const stopBtn=document.getElementById('stopScan');
    const scanResult=document.getElementById('scanResult');
    let stream=null,scanInterval=null;

    startBtn.onclick=async()=>{
      try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});video.srcObject=stream;stopBtn.disabled=false;startBtn.disabled=true;scanResult.textContent='Scanning...';
        const canvas=document.createElement('canvas');const ctx=canvas.getContext('2d');
        scanInterval=setInterval(()=>{
          if(video.readyState===video.HAVE_ENOUGH_DATA){
            canvas.width=video.videoWidth;canvas.height=video.videoHeight;
            ctx.drawImage(video,0,0,canvas.width,canvas.height);
            const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);
            const code=jsQR(imgData.data,canvas.width,canvas.height);
            if(code){scanResult.textContent=code.data;}}
        },300);
      }catch(e){alert('Camera error: '+e);}
    };
    stopBtn.onclick=()=>{if(stream){stream.getTracks().forEach(t=>t.stop());}if(scanInterval)clearInterval(scanInterval);video.srcObject=null;stopBtn.disabled=true;startBtn.disabled=false;scanResult.textContent='Stopped';};
  </script>
</body>
</html>